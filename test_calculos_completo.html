<!DOCTYPE html>
<html>
<head>
    <title>Test Cálculos - Todos los Documentos</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .correcto { background-color: #d4edda; border-color: #c3e6cb; }
        .incorrecto { background-color: #f8d7da; border-color: #f5c6cb; }
        h2 { margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .resultado { font-size: 18px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Test de Cálculos - Todos los Documentos</h1>
    <div id="resultados"></div>
    
    <script type="module">
        import { calcularTotalLinea, calcularTotalesDocumento } from './static/calculo_totales_unificado.js';
        
        const tests = [
            {
                nombre: 'Ticket T256228 - IMPRESSIO A4 COLOR',
                detalles: [
                    { precio: 0.70248, cantidad: 2, impuestos: 21 }
                ],
                esperado: { subtotal: 1.40, iva: 0.30, total: 1.70 }
            },
            {
                nombre: 'Factura - Múltiples líneas',
                detalles: [
                    { precio: 10.50, cantidad: 3, impuestos: 21 },
                    { precio: 5.25, cantidad: 2, impuestos: 21 },
                    { precio: 15.75, cantidad: 1, impuestos: 21 }
                ],
                esperado: { subtotal: 57.75, iva: 12.13, total: 69.88 }
            },
            {
                nombre: 'Proforma - Con decimales complejos',
                detalles: [
                    { precio: 0.12345, cantidad: 7, impuestos: 21 },
                    { precio: 1.98765, cantidad: 3, impuestos: 21 }
                ],
                esperado: { subtotal: 6.83, iva: 1.43, total: 8.26 }
            },
            {
                nombre: 'Presupuesto - IVA 10%',
                detalles: [
                    { precio: 25.50, cantidad: 4, impuestos: 10 }
                ],
                esperado: { subtotal: 102.00, iva: 10.20, total: 112.20 }
            },
            {
                nombre: 'Caso extremo - Precio muy bajo',
                detalles: [
                    { precio: 0.01, cantidad: 100, impuestos: 21 }
                ],
                esperado: { subtotal: 1.00, iva: 0.21, total: 1.21 }
            }
        ];
        
        let html = '';
        let todosCorrectos = true;
        
        tests.forEach(test => {
            const resultado = calcularTotalesDocumento(test.detalles);
            
            const subtotalCorrecto = Math.abs(resultado.subtotal_total - test.esperado.subtotal) < 0.01;
            const ivaCorrecto = Math.abs(resultado.iva_total - test.esperado.iva) < 0.01;
            const totalCorrecto = Math.abs(resultado.total_final - test.esperado.total) < 0.01;
            
            const esCorrecto = subtotalCorrecto && ivaCorrecto && totalCorrecto;
            if (!esCorrecto) todosCorrectos = false;
            
            html += `
                <div class="test ${esCorrecto ? 'correcto' : 'incorrecto'}">
                    <h2>${test.nombre}</h2>
                    <table>
                        <tr>
                            <th>Concepto</th>
                            <th>Precio</th>
                            <th>Cantidad</th>
                            <th>IVA</th>
                        </tr>
                        ${test.detalles.map(d => `
                            <tr>
                                <td>Detalle</td>
                                <td>${d.precio.toFixed(5)}€</td>
                                <td>${d.cantidad}</td>
                                <td>${d.impuestos}%</td>
                            </tr>
                        `).join('')}
                    </table>
                    <table>
                        <tr>
                            <th></th>
                            <th>Esperado</th>
                            <th>Calculado</th>
                            <th>Estado</th>
                        </tr>
                        <tr>
                            <td><strong>Subtotal</strong></td>
                            <td>${test.esperado.subtotal.toFixed(2)}€</td>
                            <td>${resultado.subtotal_total.toFixed(2)}€</td>
                            <td>${subtotalCorrecto ? '✓' : '✗'}</td>
                        </tr>
                        <tr>
                            <td><strong>IVA</strong></td>
                            <td>${test.esperado.iva.toFixed(2)}€</td>
                            <td>${resultado.iva_total.toFixed(2)}€</td>
                            <td>${ivaCorrecto ? '✓' : '✗'}</td>
                        </tr>
                        <tr>
                            <td><strong>Total</strong></td>
                            <td>${test.esperado.total.toFixed(2)}€</td>
                            <td>${resultado.total_final.toFixed(2)}€</td>
                            <td>${totalCorrecto ? '✓' : '✗'}</td>
                        </tr>
                    </table>
                    <div class="resultado" style="color: ${esCorrecto ? 'green' : 'red'}">
                        ${esCorrecto ? '✓ CORRECTO' : '✗ INCORRECTO'}
                    </div>
                </div>
            `;
        });
        
        html = `
            <div style="padding: 20px; background-color: ${todosCorrectos ? '#d4edda' : '#f8d7da'}; 
                        border: 2px solid ${todosCorrectos ? '#c3e6cb' : '#f5c6cb'}; 
                        border-radius: 5px; margin-bottom: 20px;">
                <h2 style="margin: 0; color: ${todosCorrectos ? 'green' : 'red'}">
                    ${todosCorrectos ? '✓ TODOS LOS TESTS PASARON' : '✗ ALGUNOS TESTS FALLARON'}
                </h2>
                <p style="margin: 10px 0 0 0;">
                    ${tests.filter((t, i) => {
                        const r = calcularTotalesDocumento(t.detalles);
                        return Math.abs(r.total_final - t.esperado.total) < 0.01;
                    }).length} de ${tests.length} tests correctos
                </p>
            </div>
        ` + html;
        
        document.getElementById('resultados').innerHTML = html;
    </script>
</body>
</html>
