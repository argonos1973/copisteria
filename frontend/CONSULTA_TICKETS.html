<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tickets</title>

  <!-- Incluir Font Awesome para iconos -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    <link rel="stylesheet" href="../static/page_header.css">

  <!-- Cargar tu archivo de estilos externo -->
  <link rel="stylesheet" href="../static/styles.css" />
  <link rel="stylesheet" href="../static/notificaciones.css" />
  <link rel="stylesheet" href="../static/footer.css" />
  <style>
    /* Hacer que la página use layout de columna a altura completa, como Productos */
    /* En esta vista anulamos el padding-bottom global que añade footer.css al body */
    .tickets-page { padding-bottom: 0 !important; }

    .container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 96px); /* reserva exacta para el footer fijo */
      min-height: 100vh;
      box-sizing: border-box;
    }
    /* Recuperar altura para el grid anulando el gran margen del footer.css en esta vista */
    .tickets-page .pagination { margin-bottom: 8px !important; }
    /* El footer.css añade padding-bottom a .container; lo anulamos aquí para maximizar el alto del grid */
    .tickets-page .container { padding-bottom: 0 !important; }
    .table-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0; /* Necesario para que el hijo con overflow pueda encoger */
    }
    .table-responsive {
      flex: 1;
      max-height: none !important;
      height: 100% !important; /* ocupa todo el alto disponible */
      overflow-y: auto;
    }
    /* Reducir márgenes verticales para ganar área de grid */
    .form-inline { margin: 4px 0; }
    .pagination { margin-top: 6px; }
  </style>
</head>
<body class="tickets-page">

  <div class="container">
    <div class="page-header" style="background: linear-gradient(90deg, #000000 0%, rgba(0,0,0,0.8) 30%, rgba(0,0,0,0.4) 60%, rgba(0,0,0,0.1) 80%, transparent 100%) !important; padding: 8px 25px !important; margin: 0 0 20px 0; border-radius: 8px; color: #ffffff !important;">
      <h1 style="color: #ffffff !important; margin: 0; font-size: 1.6em;">Tickets</h1>
    </div>
    <div class="form-inline">
      <div class="form-group">
        <label for="startDate">Fecha inicio:</label>
        <input type="date" id="startDate" />
      </div>
      <div class="form-group">
        <label for="endDate">Fecha fin:</label>
        <input type="date" id="endDate" />
      </div>
      <div class="form-group">
        <label for="status">Estado:</label>
        <select id="status">
          <option value="">Todos</option>
          <option value="P">Pendiente</option>
          <option value="C">Cobrado</option>
          <option value="RF">Rectificativo</option>
          <option value="A">Anulado</option>
        </select>
      </div>
      <div class="form-group">
        <label for="ticketNumber">Núm. Ticket:</label>
        <input type="text" id="ticketNumber" placeholder="Ej: 12345" />
      </div>
      <div class="form-group">
        <label for="paymentMethod">Forma de Pago:</label>
        <select id="paymentMethod">
          <option value="">Todos</option>
          <option value="E">Efectivo</option>
          <option value="T">Tarjeta</option>
        </select>
      </div>
      <div class="form-group">
        <label for="conceptFilter">Concepto:</label>
        <input type="text" id="conceptFilter" placeholder="Ej: café" />
      </div>
      <div class="form-group">
        <button id="btn-nuevo-ticket">Nuevo Ticket</button>
      </div>
    </div>

    <!-- Controles de paginación (debajo de filtros, compactos) -->
    <div class="pagination" style="display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:6px;margin-bottom:4px;padding:6px 8px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa">
      <div style="display:flex;align-items:center;gap:12px;">
        <button id="prevPageTickets" class="btn btn-secondary" style="padding:4px 8px;font-size:12px;">⟨</button>
        <span id="pageInfoTickets">Página 1 de 1</span>
        <button id="nextPageTickets" class="btn btn-secondary" style="padding:4px 8px;font-size:12px;">⟩</button>
      </div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
        <label>Por página:
          <select id="pageSizeSelectTickets" style="padding:2px 6px;font-size:12px;">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </label>
      </div>
    </div>

    <div class="table-container" style="margin-top:0; min-height:0; flex:1;">
      <div class="table-responsive">
        <table class="grid" id="resultGrid">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Número</th>
              <th class="text-right">Bruto</th>
              <th class="text-right">Impuestos</th>
              <th class="text-right">Cobrado</th>
              <th class="text-right">Total</th>
              <th class="text-center">Estado</th>
              <th class="text-center">Pago</th>
              <th class="text-center col-imprimir" style="width: 40px;"><i class="fas fa-print"></i></th>
            </tr>
          </thead>
          <tbody id="gridBody">
            <!-- Los resultados se mostrarán aquí -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="fixed-footer fixed-footer-ticket">
    <table class="grid">
      <tr>
        <td class="label-totales" style="width: 100px;"><span class="content-cell hidden"><strong>Totales:</strong></span></td>
        <td style="width: 100px;"></td>
        <td class="text-right" style="width: 100px;"><span class="content-cell total-data hidden" id="totalImporteBruto">0,00 €</span></td>
        <td class="text-right" style="width: 100px;"><span class="content-cell total-data hidden" id="totalImporteImpuestos">0,00 €</span></td>
        <td class="text-right" style="width: 100px;"><span class="content-cell total-data hidden" id="totalImporteCobrado">0,00 €</span></td>
        <td class="text-right" style="width: 100px;"><span class="content-cell total-data hidden" id="totalTotal">0,00 €</span></td>
        <td style="width: 100px;"></td>
        <td style="width: 100px;"></td>
        <td class="text-center" style="width: 40px; position: relative;">
          <div class="toggle-totals">
            <i class="fas fa-eye-slash"></i>
          </div>
        </td>
      </tr>
    </table>
  </div>

  <!-- Script principal (módulo) -->
  <script type="module" src="../static/consulta_tickets.js" defer></script>
  
  <!-- Overlay para oscurecer la pantalla -->
  <div id="overlay" class="overlay">
    <div class="progress-container">
      <div id="progress-bar" class="progress-bar">
        <div class="progress-bar-fill"></div>
      </div>
      <p>Cargando, por favor espera...</p>
    </div>
  </div>

  <!-- Script para mostrar/ocultar la fila de totales -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const toggleTotals = document.querySelector('.toggle-totals');
      const totalDataCells = document.querySelectorAll('.fixed-footer-ticket .content-cell');
      const icon = toggleTotals.querySelector('i');

      function updateIcon(show) {
        if (show) {
          icon.classList.remove('fa-eye-slash');
          icon.classList.add('fa-eye');
          toggleTotals.setAttribute('aria-pressed', 'true');
        } else {
          icon.classList.remove('fa-eye');
          icon.classList.add('fa-eye-slash');
          toggleTotals.setAttribute('aria-pressed', 'false');
        }
      }

      function showTotals() {
        totalDataCells.forEach(cell => cell.classList.remove('hidden'));
        updateIcon(true);
      }

      function hideTotals() {
        totalDataCells.forEach(cell => cell.classList.add('hidden'));
        updateIcon(false);
      }

      const totalsVisible = sessionStorage.getItem('totalsVisible');
      if (totalsVisible === 'true') {
        showTotals();
      } else {
        hideTotals();
      }

      toggleTotals.addEventListener('click', function() {
        let currentlyVisible = sessionStorage.getItem('totalsVisible') === 'true';
        if (currentlyVisible) {
          hideTotals();
        } else {
          showTotals();
        }
        sessionStorage.setItem('totalsVisible', !currentlyVisible);
      });

      toggleTotals.addEventListener('keypress', function(event) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          toggleTotals.click();
        }
      });
    });
  </script>
</body>
</html>
