<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Selector de Plantillas</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; }
.container { max-width: 800px; margin: 0 auto; background: var(--bg-elevated); padding: 30px; border-radius: 12px; }
h1 { color: var(--text); margin-bottom: 10px; }
.subtitle { color: var(--text); opacity: 0.7; margin-bottom: 30px; }
.plantillas-grid { display: grid; gap: 15px; }
.plantilla-card { background: var(--bg); border: 2px solid var(--border); border-radius: 10px; padding: 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; }
.plantilla-card:hover { border-color: var(--primary); }
.plantilla-card.active { border-color: var(--primary); background: var(--primary); }
.plantilla-card.active * { color: white; }
.plantilla-icon { font-size: 32px; width: 50px; text-align: center; }
.plantilla-nombre { font-weight: 600; font-size: 18px; }
.plantilla-desc { opacity: 0.7; font-size: 13px; }
.status { background: var(--success); color: white; padding: 8px 16px; border-radius: 6px; margin-top: 20px; display: none; }
.status.show { display: block; }
#logs { display: none; margin-top: 20px; background: #f5f5f5; color: #000; padding: 10px; border-radius: 6px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto; }
</style>
</head>
<body>
<div class="container">
<h1>Selector de Plantillas</h1>
<p class="subtitle">Elige una plantilla para toda la aplicaci√≥n</p>
<div id="grid" class="plantillas-grid"></div>
<div id="status" class="status"></div>
<div id="logs"></div>
</div>
<script src="/static/branding.js"></script>
<script>
const API = '/api';
const plantillas = {
minimal: {name:'Minimal', icon:'‚ú®', desc:'Minimalista'},
dark: {name:'Dark', icon:'üåô', desc:'Tema oscuro'},
eink: {name:'EInk', icon:'üìñ', desc:'Inspirado en e-Ink'},
'eink-mono': {name:'E-Ink Monochrome', icon:'üìñ', desc:'Escala de grises'}
};
let empresaId;

function log(msg) {
console.log(msg);
document.getElementById('logs').innerHTML += msg + '<br>';
}

async function init() {
try {
log('[INIT] Cargando...');
let data;
try {
const r = await fetch('/api/auth/branding');
data = await r.json();
log('[INIT] Branding: ' + JSON.stringify(data));
if (data.empresa_id) empresaId = data.empresa_id;
} catch(e) {
log('[INIT] Error branding: ' + e.message);
}

if (!empresaId) {
try {
const r = await fetch('/api/auth/session');
const s = await r.json();
if (s.empresa_id) empresaId = s.empresa_id;
} catch(e) {}
}

if (!empresaId) empresaId = 1;
log('[INIT] Empresa ID: ' + empresaId);

render(data?.plantilla || 'minimal');
const t = await (await fetch('/static/plantillas/' + (data?.plantilla || 'minimal') + '.json')).json();
if (typeof applyTheme === 'function') await applyTheme(t);
} catch(e) {
log('[ERROR] ' + e.message);
}
}

function render(actual) {
const g = document.getElementById('grid');
g.innerHTML = '';
for (const [k, p] of Object.entries(plantillas)) {
const c = document.createElement('div');
c.className = 'plantilla-card' + (k === actual ? ' active' : '');
c.innerHTML = '<div class="plantilla-icon">' + p.icon + '</div><div class="plantilla-info"><div class="plantilla-nombre">' + p.name + '</div><div class="plantilla-desc">' + p.desc + '</div></div>';
c.onclick = () => select(k);
g.appendChild(c);
}
}

async function select(nombre) {
const s = document.getElementById('status');
s.textContent = 'Aplicando...';
s.classList.add('show');
log('[SELECT] ' + nombre);
document.querySelectorAll('.plantilla-card').forEach(c => c.classList.remove('active'));
event.currentTarget.classList.add('active');
try {
const t = await (await fetch('/static/plantillas/' + nombre + '.json', {cache:'no-cache'})).json();
log('[SELECT] JSON: ' + t.name);
if (typeof applyTheme === 'function') await applyTheme(t);
if (window.parent && typeof window.parent.applyTheme === 'function') await window.parent.applyTheme(t);

log('[SELECT] Guardando... ID:' + empresaId);
const r = await fetch(API + '/empresas/' + empresaId + '/colores', {
method: 'PUT',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({plantilla_personalizada: nombre})
});
log('[SELECT] Status: ' + r.status);
if (r.ok) {
const res = await r.json();
log('[SELECT] OK: ' + JSON.stringify(res));
s.textContent = '‚úÖ Guardada';
} else {
log('[SELECT] Error: ' + await r.text());
s.textContent = '‚ö†Ô∏è Error guardando';
}
setTimeout(() => s.classList.remove('show'), 3000);
} catch(e) {
log('[ERROR] ' + e.message);
s.textContent = '‚ùå Error';
}
}

init();
</script>
</body>
</html>
