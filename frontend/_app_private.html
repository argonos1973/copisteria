<!-- Version: 1761152613 -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- CSS base que usa variables CSS generadas por applyTheme -->
    <link rel="stylesheet" href="/static/theme-base.css?v=1761938648">
    <!-- CSS que consume las variables del tema y las aplica a la UI -->
    <link rel="stylesheet" href="/static/theme-consumer.css?v=1762362531">
    <link rel="stylesheet" href="/static/styles.css?v=1761938648">
    <link rel="stylesheet" href="/static/notificaciones.css">
    <link rel="stylesheet" href="/static/footer.css">
    <link rel="stylesheet" href="/static/page_header.css">
    <link rel="stylesheet" href="/static/app_private.css?v=1762280740">
    <!-- CSS inline eliminado - movido a app_private.css -->
</head>
<body>
    <div class="layout-container">
        <nav class="menu">
            <div class="logo-container" style="padding: 1rem; margin-bottom: 0.5rem; text-align: center;">
                <img id="logo-empresa" src="/static/logos/default_header.png" alt="Logo" style="max-width: 200px; height: auto;">
            </div>
            
            <!-- Iconos de notificaciones y cerrar sesión -->
            <div style="padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; gap: 15px;">
                <div id="notificaciones-icon" style="position: relative; cursor: pointer;">
                    <i class="fas fa-bell" style="font-size: 20px; color: white;"></i>
                    <span id="notificaciones-badge" style="display: none; position: absolute; top: -8px; right: -8px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 11px; font-weight: bold; text-align: center; line-height: 20px;">0</span>
                </div>
                <div onclick="cerrarSesion()" style="cursor: pointer;" title="Cerrar Sesión">
                    <i class="fas fa-sign-out-alt" style="font-size: 20px; color: white;"></i>
                </div>
            </div>
            
            <!-- Información de sesión -->
            <div style="padding: 0.5rem 1rem; border-top: 1px solid rgba(255,255,255,0.1); margin-bottom: 1rem;">
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-bottom: 5px; cursor: pointer;" 
                     onclick="abrirModalPerfil()" 
                     onmouseover="this.style.background='rgba(255,255,255,0.1)'"
                     onmouseout="this.style.background='transparent'"
                     title="Click para ver tu perfil">
                    <i class="fas fa-user" style="margin-right: 5px;"></i>
                    <span id="menu-usuario-nombre">Usuario</span>
                    <i class="fas fa-cog" style="margin-left: 5px; font-size: 10px; opacity: 0.7;"></i>
                </div>
                <div style="color: rgba(255,255,255,0.7); font-size: 12px; margin-bottom: 5px;">
                    <i class="fas fa-building" style="margin-right: 5px;"></i>
                    <span id="menu-empresa-nombre">Empresa</span>
                </div>
                <div style="color: rgba(255,255,255,0.5); font-size: 11px;">
                    <i class="fas fa-clock" style="margin-right: 5px;"></i>
                    Último acceso: <span id="menu-ultimo-acceso">--:--</span>
                </div>
            </div>
            
            <ul class="menu-list">
                <!-- El menú se cargará dinámicamente según permisos -->
                <li class="menu-loading">
                    <i class="fas fa-spinner fa-spin"></i> Cargando menú...
                </li>
            </ul>
            
            <!-- Versión de la aplicación -->
            <div id="menu-version" style="padding: 0.5rem 1rem; border-top: 1px solid rgba(255,255,255,0.1); margin-top: auto; text-align: left;">
                <div style="color: rgba(255,255,255,0.5); font-size: 10px;">
                    <i class="fas fa-code-branch" style="margin-right: 5px;"></i>
                    <span id="app-version">v1.0.4</span>
                </div>
            </div>
        </nav>
        
        <div class="content-container" style="flex-grow: 1; height: 100vh; overflow: hidden;">
            <div style="height: 100%;">
                <iframe id="content-frame" name="content-frame" src="about:blank" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
        </div>
    </div>

    <!-- Panel de notificaciones -->
    <div id="notificaciones-panel">
        <div class="notif-header">
            <div style="display: flex; align-items: center; gap: 10px; flex: 1;">
                <label id="select-all-container" style="display: none; align-items: center; gap: 5px; cursor: pointer; font-size: 14px;">
                    <input type="checkbox" id="select-all-notif" onchange="toggleSeleccionarTodas()" style="cursor: pointer; width: 16px; height: 16px;">
                    <span>Todas</span>
                </label>
                <h3 style="margin: 0;"><i class="fas fa-bell"></i> Notificaciones</h3>
            </div>
            <span class="notif-close" onclick="cerrarNotificaciones()">&times;</span>
        </div>
        <div class="notif-body" id="notificaciones-lista">
            <div class="notif-empty">
                <i class="fas fa-check-circle" class="notif-empty-icon"></i>
                <p>No hay notificaciones nuevas</p>
            </div>
        </div>
        <div class="notif-footer" id="notif-footer" style="display: none;">
            <button onclick="marcarSeleccionadasLeidas()" id="btn-marcar-leidas">Marcar seleccionadas como leídas</button>
        </div>
    </div>

    <link rel="stylesheet" href="/static/notificaciones.css">
    <script type="module">
        import { mostrarConfirmacion, mostrarNotificacion } from '/static/notificaciones.js';
        window.mostrarConfirmacion = mostrarConfirmacion;
        window.mostrarNotificacion = mostrarNotificacion;
    </script>
    
    <!-- Cargador de menú dinámico -->
    <script src="/static/menu_loader.js?v=1761938648"></script>
    <!-- Sistema de permisos -->
    <script src="/static/permisos.js"></script>

    
    <!-- Manejador de navegación del menú -->
    <script src="/static/menu.js?v=v20251102_171031"></script>
    
    <!-- Branding y colores de empresa -->
    <script src="/static/branding.js?v=1762345385184"></script>

    <!-- Funciones principales de la aplicación -->
    <script src="/static/app_private.js?v=1761938648"></script>

    <!-- Cargar versión de la aplicación -->
    <script>
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();
                const versionElement = document.getElementById('app-version');
                if (versionElement && data.version) {
                    versionElement.textContent = `v${data.version}`;
                }
            } catch (error) {
                console.error('[MENU] Error cargando versión:', error);
            }
        });
    </script>

    <!-- Modal de Perfil de Usuario -->
    <div id="modal-perfil" class="modal-perfil" style="display: none;">
        <div class="modal-perfil-content">
            <div class="modal-perfil-header">
                <h2><i class="fas fa-user-circle"></i> Mi Perfil</h2>
                <span class="modal-perfil-close" onclick="cerrarModalPerfil()">&times;</span>
            </div>
            
            <!-- Pestañas -->
            <div class="modal-perfil-tabs">
                <button class="tab-btn active" onclick="cambiarTab('datos')"><i class="fas fa-user"></i> Datos Personales</button>
                <button class="tab-btn" onclick="cambiarTab('password')"><i class="fas fa-key"></i> Contraseña</button>
                <button class="tab-btn" onclick="cambiarTab('plantilla')"><i class="fas fa-palette"></i> Plantilla</button>
            </div>
            
            <!-- Tab: Datos Personales -->
            <div id="tab-datos" class="tab-content active">
                <form id="form-datos" onsubmit="return guardarDatos(event)">
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Nombre de usuario</label>
                        <input type="text" id="perfil-username" disabled>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="perfil-email" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Teléfono</label>
                        <input type="tel" id="perfil-telefono">
                    </div>
                    <button type="submit" class="btn-guardar"><i class="fas fa-save"></i> Guardar Cambios</button>
                </form>
            </div>
            
            <!-- Tab: Contraseña -->
            <div id="tab-password" class="tab-content">
                <form id="form-password" onsubmit="return cambiarPassword(event)">
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Contraseña Actual</label>
                        <input type="password" id="password-actual" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Nueva Contraseña</label>
                        <input type="password" id="password-nueva" required minlength="6">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-lock"></i> Confirmar Nueva Contraseña</label>
                        <input type="password" id="password-confirmar" required>
                    </div>
                    <button type="submit" class="btn-guardar"><i class="fas fa-key"></i> Cambiar Contraseña</button>
                </form>
            </div>
            
            <!-- Tab: Plantilla -->
            <div id="tab-plantilla" class="tab-content">
                <div class="plantillas-grid" id="plantillas-grid">
                    <!-- Se llenarán dinámicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Estilos de la modal -->
    <style>
        .modal-perfil {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            animation: fadeIn 0.3s;
        }
        
        .modal-perfil-content {
            background-color: var(--bg-card, #fff);
            color: var(--color-texto, #333);
            margin: 3% auto;
            padding: 0;
            border: 1px solid var(--color-border, #ddd);
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            animation: slideDown 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-perfil-header {
            padding: 20px 25px;
            background: var(--primary, var(--color-primario, #3498db));
            color: white;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-perfil-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
        }
        
        .modal-perfil-close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s;
        }
        
        .modal-perfil-close:hover {
            transform: rotate(90deg);
        }
        
        .modal-perfil-tabs {
            display: flex;
            border-bottom: 2px solid var(--color-border, #ddd);
            background: var(--bg-secondary, #f8f9fa);
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: var(--color-texto-secondary, #666);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn:hover {
            background: var(--bg-hover, #f0f0f0);
            color: var(--primary, var(--color-primario, #3498db));
        }
        
        .tab-btn.active {
            color: var(--primary, var(--color-primario, #3498db));
            border-bottom-color: var(--primary, var(--color-primario, #3498db));
            background: var(--bg-card, #fff);
        }
        
        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--color-texto, #333);
            font-size: 14px;
        }
        
        .form-group label i {
            margin-right: 8px;
            color: var(--primary, var(--color-primario, #3498db));
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--color-border, #ddd);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: var(--bg-input, #fff);
            color: var(--color-texto, #333);
            box-sizing: border-box;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary, var(--color-primario, #3498db));
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-group input:disabled {
            background: var(--bg-disabled, #f5f5f5);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .btn-guardar {
            width: 100%;
            padding: 14px;
            background: var(--primary, var(--color-primario, #3498db));
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .btn-guardar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .btn-guardar:active {
            transform: translateY(0);
        }
        
        .plantillas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .plantilla-card-perfil {
            padding: 20px 15px;
            border: 3px solid var(--color-border, #ddd);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-card, #fff);
        }
        
        .plantilla-card-perfil:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: var(--primary, var(--color-primario, #3498db));
        }
        
        .plantilla-card-perfil.active {
            border-color: var(--primary, var(--color-primario, #3498db));
            background: var(--bg-hover, #f0f0f0);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }
        
        .plantilla-card-perfil .plantilla-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .plantilla-card-perfil .plantilla-nombre {
            font-weight: 600;
            font-size: 14px;
            color: var(--color-texto, #333);
        }
        
        .plantilla-card-perfil .plantilla-check {
            display: none;
            color: var(--primary, var(--color-primario, #3498db));
            font-size: 20px;
            margin-top: 8px;
        }
        
        .plantilla-card-perfil.active .plantilla-check {
            display: block;
        }
    </style>

    <!-- JavaScript de la modal -->
    <script>
        let datosUsuarioActual = {};
        
        async function abrirModalPerfil() {
            try {
                // Cargar datos del usuario
                const response = await fetch('/api/auth/session');
                const data = await response.json();
                
                datosUsuarioActual = data;
                
                // Llenar formulario de datos
                document.getElementById('perfil-username').value = data.username || '';
                document.getElementById('perfil-email').value = data.email || '';
                document.getElementById('perfil-telefono').value = data.telefono || '';
                
                // Cargar plantillas disponibles
                await cargarPlantillasModal();
                
                // Mostrar modal
                document.getElementById('modal-perfil').style.display = 'block';
            } catch (error) {
                console.error('Error cargando perfil:', error);
                alert('Error al cargar datos del perfil');
            }
        }
        
        function cerrarModalPerfil() {
            document.getElementById('modal-perfil').style.display = 'none';
            // Limpiar contraseñas
            document.getElementById('form-password').reset();
        }
        
        function cambiarTab(tab) {
            // Desactivar todos los tabs
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Activar tab seleccionado
            event.target.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }
        
        async function guardarDatos(event) {
            event.preventDefault();
            
            try {
                const datos = {
                    email: document.getElementById('perfil-email').value,
                    telefono: document.getElementById('perfil-telefono').value
                };
                
                const response = await fetch('/api/usuario/perfil', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('✅ Datos actualizados correctamente');
                } else {
                    alert('❌ Error: ' + (result.error || 'No se pudieron actualizar los datos'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('❌ Error al guardar datos');
            }
        }
        
        async function cambiarPassword(event) {
            event.preventDefault();
            
            const passwordActual = document.getElementById('password-actual').value;
            const passwordNueva = document.getElementById('password-nueva').value;
            const passwordConfirmar = document.getElementById('password-confirmar').value;
            
            if (passwordNueva !== passwordConfirmar) {
                alert('❌ Las contraseñas no coinciden');
                return;
            }
            
            if (passwordNueva.length < 6) {
                alert('❌ La contraseña debe tener al menos 6 caracteres');
                return;
            }
            
            try {
                const response = await fetch('/api/auth/cambiar-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password_actual: passwordActual,
                        password_nueva: passwordNueva
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    mostrarNotificacion('Contraseña cambiada correctamente', 'success');
                    document.getElementById('form-password').reset();
                } else {
                    mostrarNotificacion('Error: ' + (result.error || 'No se pudo cambiar la contraseña'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al cambiar contraseña', 'error');
            }
        }
        
        async function cargarPlantillasModal() {
            try {
                // Obtener plantilla actual del usuario
                const brandingResponse = await fetch('/api/auth/branding');
                const branding = await brandingResponse.json();
                const plantillaActual = branding.plantilla || 'dark';
                
                // Obtener plantillas disponibles desde el backend (dinámico)
                const plantillasResponse = await fetch('/api/usuario/plantillas');
                const plantillasData = await plantillasResponse.json();
                
                if (!plantillasData.success || !plantillasData.plantillas) {
                    console.error('Error obteniendo plantillas:', plantillasData.error);
                    mostrarNotificacion('Error cargando plantillas', 'error');
                    return;
                }
                
                const plantillas = plantillasData.plantillas;
                
                const grid = document.getElementById('plantillas-grid');
                grid.innerHTML = plantillas.map(p => `
                    <div class="plantilla-card-perfil ${p.id === plantillaActual ? 'active' : ''}" 
                         data-plantilla="${p.id}"
                         onclick="cambiarPlantillaUsuario('${p.id}', this)">
                        <div class="plantilla-icon">${p.icono}</div>
                        <div class="plantilla-nombre">${p.nombre}</div>
                        <div class="plantilla-check"><i class="fas fa-check-circle"></i></div>
                    </div>
                `).join('');
                
                console.log(`✅ ${plantillas.length} plantillas cargadas dinámicamente`);
            } catch (error) {
                console.error('Error cargando plantillas:', error);
                mostrarNotificacion('Error cargando plantillas', 'error');
            }
        }
        
        async function cambiarPlantillaUsuario(plantilla, clickedElement) {
            try {
                const response = await fetch('/api/usuario/plantilla', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ plantilla: plantilla })
                });
                
                const result = await response.json();
                
                if (response.ok && result.colores) {
                    // Aplicar tema inmediatamente
                    if (typeof applyTheme === 'function') {
                        await applyTheme(result.colores);
                    }
                    
                    // Actualizar UI de la modal
                    document.querySelectorAll('.plantilla-card-perfil').forEach(card => {
                        card.classList.remove('active');
                    });
                    
                    // Marcar la plantilla seleccionada como activa
                    const cardToActivate = clickedElement || document.querySelector(`.plantilla-card-perfil[data-plantilla="${plantilla}"]`);
                    if (cardToActivate) {
                        cardToActivate.classList.add('active');
                    }
                    
                    mostrarNotificacion('Plantilla cambiada correctamente', 'success');
                    
                    // Recargar página para aplicar cambios en iframe
                    setTimeout(() => location.reload(), 500);
                } else {
                    mostrarNotificacion('Error: ' + (result.error || 'No se pudo cambiar la plantilla'), 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('Error al cambiar plantilla', 'error');
            }
        }
        
        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modal-perfil');
            if (event.target === modal) {
                cerrarModalPerfil();
            }
        }
    </script>
</body>
</html>
<!-- Version: 20251026_refactored - CSS y JS movidos a archivos externos -->

<script>
// Inicializar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', async () => {
    console.log('[INIT] Iniciando aplicación...');
    
    // Cargar menú según permisos
    if (window.verificarSesionYCargarMenu) {
        await verificarSesionYCargarMenu();
    } else {
        console.error('[INIT] verificarSesionYCargarMenu no está definida');
    }
    
    // Cargar notificaciones
    if (window.cargarNotificaciones) {
        cargarNotificaciones();
    }
});

// Función para cerrar sesión
async function cerrarSesion() {
    try {
        await fetch('/api/auth/logout', { method: 'POST' });
        window.location.href = '/LOGIN.html';
    } catch (error) {
        console.error('Error cerrando sesión:', error);
        window.location.href = '/LOGIN.html';
    }
}
</script>
