<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Consulta de Contactos</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
    rel="stylesheet"
  />

  <!-- Enlace al archivo de estilos externo -->
  <link rel="stylesheet" href="../static/styles.css" />
  <link rel="stylesheet" href="../static/notificaciones.css" />
  
  <style>
    /* Estilos personalizados para la tabla de contactos */
    /* En esta vista anulamos padding inferior global y reservamos el alto del footer */
    .contactos-page { padding-bottom: 0 !important; }
    #app.container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 96px);
      min-height: 100vh;
      box-sizing: border-box;
      padding-bottom: 0 !important;
    }
    
    .table-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin-top: 10px;
      min-height: 0;
    }
    
    .table-responsive {
      flex: 1;
      max-height: none !important;
      height: 100% !important;
      overflow-y: auto;
    }
    /* Compactar espacios para ganar área de grid */
    h1 { margin: 6px 0; }
    .form-inline { margin: 4px 0; }
    .pagination { margin-top: 6px; }
    .contactos-page .pagination { margin-bottom: 8px !important; }
  </style>

  <!-- Vue.js y Axios (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="contactos-page">
  <div id="app" class="container">
    <div class="page-header" style="background: linear-gradient(90deg, #000000 0%, rgba(0,0,0,0.8) 30%, rgba(0,0,0,0.4) 60%, rgba(0,0,0,0.1) 80%, transparent 100%) !important; padding: 8px 25px !important; margin: 0 0 20px 0; border-radius: 8px; color: #ffffff !important;">
      <h1 style="color: #ffffff !important; margin: 0;">Contactos</h1>
    </div>
    
    <!-- Contenedor de Filtros -->
    <div class="form-inline">
      <div class="form-group">
        <label for="razonSocialInput">Razón Social:</label>
        <input
          type="text"
          id="razonSocialInput"
          v-model="filters.razonSocial"
          placeholder="Nombre del contacto..."
          @input="handleSearch"
        />
      </div>
      <div class="form-group">
        <label for="nifInput">Identificador:</label>
        <input
          type="text"
          id="nifInput"
          v-model="filters.nif"
          placeholder="Identificador del contacto..."
          @input="handleSearch"
        />
      </div>
      <div class="form-group">
        <button @click="nuevoContacto">Nuevo Contacto</button>
      </div>
    </div>

    <!-- Controles de paginación (debajo de filtros, compacto) -->
    <div class="pagination" style="display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:6px;margin-bottom:4px;padding:6px 8px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa">
      <div style="display:flex;align-items:center;gap:12px;">
        <button @click="prevPage" :disabled="loading || pagination.page<=1" style="padding:4px 8px;font-size:12px;">⟨</button>
        <span>Página {{ pagination.page }} de {{ pagination.totalPages }}</span>
        <button @click="nextPage" :disabled="loading || pagination.page>=pagination.totalPages" style="padding:4px 8px;font-size:12px;">⟩</button>
      </div>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
        <label>Por página:
          <select :value="pagination.pageSize" @change="changePageSize($event.target.value)" style="padding:2px 6px;font-size:12px;">
            <option :selected="pagination.pageSize===10" value="10">10</option>
            <option :selected="pagination.pageSize===20" value="20" selected>20</option>
            <option :selected="pagination.pageSize===50" value="50">50</option>
            <option :selected="pagination.pageSize===100" value="100">100</option>
          </select>
        </label>
      </div>
    </div>

    <!-- Contenedor de la Tabla -->
    <div class="table-container" style="margin-top:0; min-height:0; flex:1;">
      <div class="table-responsive">
        <table class="grid">
          <thead>
            <tr>
              <th class="razon-social" style="width: 40%;">Razón Social</th>
              <th class="nif-col">Identificador</th>
              <th class="email-col">Email</th>
              <th class="proforma-col" title="Proforma Abierta">Proforma</th>
              <th class="acciones-col" title="Crear Proforma">✎</th>
              <th class="acciones-col" title="Crear Factura">⚡</th>
              <th class="acciones-col" title="Eliminar">✕</th>
            </tr>
          </thead>
          <tbody>
            <!-- Mensaje de carga -->
            <tr v-if="loading">
              <td colspan="6" style="text-align: center;">Cargando contactos...</td>
            </tr>

            <!-- Mensaje de sin resultados -->
            <tr v-if="!loading && contactos.length === 0">
              <td colspan="6" style="text-align: left;">No se encontraron contactos.</td>
            </tr>

            <!-- Filas de contactos -->
            <tr
              v-for="contacto in contactos"
              :key="contacto.idContacto"
              @click="verContacto(contacto.idContacto)"
            >
              <td class="razon-social" :title="contacto.razonsocial">
                {{ contacto.razonsocial }}
              </td>
              <td class="nif-col" :title="contacto.identificador">
                {{ contacto.identificador }}
              </td>
              <td class="email-col" :title="contacto.mail">
                {{ contacto.mail }}
              </td>
              <td class="proforma-col" :title="contacto.numero_proforma_abierta">
                {{ contacto.numero_proforma_abierta }}
              </td>
              <td class="acciones-col">
                <button
                  v-if="contacto.identificador"
                  class="btn-icon"
                  :title="contacto.numero_proforma_abierta ? 'Modificar Proforma' : 'Crear Proforma'"
                  @click.stop="crearProforma(contacto.idContacto)"
                >
                  ✎
                </button>
              </td>
              <td class="acciones-col">
                <button
                  v-if="contacto.identificador"
                  class="btn-icon"
                  title="Crear Factura"
                  @click.stop="crearFactura(contacto.idContacto)"
                >
                  ⚡
                </button>
              </td>
              <td class="acciones-col">
                <button
                  class="btn-icon"
                  title="Eliminar"
                  @click.stop="deleteContacto(contacto.idContacto)"
                >
                  ✕
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <!-- Un solo script "type=module" para importar y usar las constantes -->
  <script type="module">
    import { IP_SERVER, PORT } from '../static/constantes.js?v=1758744785';
    import { mostrarNotificacion, mostrarConfirmacion } from '../static/notificaciones.js';

    const { createApp, ref, reactive, onMounted } = Vue;

    createApp({
      setup() {
        // Construimos la URL de la API con las constantes importadas
        const API_URL = `http://${IP_SERVER}:${PORT}/api`;

        // Reactive data
        const filters = reactive({
          razonSocial: '',
          nif: ''
        });

        const contactos = ref([]);
        const loading = ref(false);
        const pagination = reactive({
          page: 1,
          pageSize: 10,
          totalPages: 1,
          sort: 'razonsocial',
          order: 'ASC'
        });

        // Función para guardar filtros en sessionStorage
        const guardarFiltros = () => {
          sessionStorage.setItem('filtrosContactos', JSON.stringify({
            razonSocial: filters.razonSocial,
            nif: filters.nif,
            page: pagination.page,
            pageSize: pagination.pageSize
          }));
        };

        // Función para restaurar filtros desde sessionStorage
        const restaurarFiltros = () => {
          const filtrosGuardados = sessionStorage.getItem('filtrosContactos');
          if (filtrosGuardados) {
            const f = JSON.parse(filtrosGuardados);
            filters.razonSocial = f.razonSocial || '';
            filters.nif = f.nif || '';
            pagination.page = Number(f.page) > 0 ? Number(f.page) : 1;
            pagination.pageSize = [10,20,50,100].includes(Number(f.pageSize)) ? Number(f.pageSize) : 20;
          } else {
            filters.razonSocial = '';
            filters.nif = '';
            pagination.page = 1;
            pagination.pageSize = 20;
            guardarFiltros();
          }
          fetchContactos();
        };

        // Llamada a la API de contactos (paginado)
        const fetchContactos = async () => {
          try {
            loading.value = true;
            const queryParams = new URLSearchParams({
              razonSocial: filters.razonSocial,
              nif: filters.nif,
              page: String(pagination.page),
              page_size: String(pagination.pageSize),
              sort: pagination.sort,
              order: pagination.order
            });

            const response = await fetch(`${API_URL}/contactos/paginado?${queryParams}`);
            if (!response.ok) throw new Error('Error en la búsqueda');
            
            const data = await response.json();
            contactos.value = data.items || [];
            pagination.totalPages = data.total_pages || 1;
          } catch (error) {
            console.error('Error:', error);
            contactos.value = [];
            pagination.totalPages = 1;
          } finally {
            loading.value = false;
          }
        };

        // Eliminar contacto
        const deleteContacto = async (id) => {
          try {
            const confirmado = await mostrarConfirmacion('¿Está seguro de eliminar este contacto?');
            if (confirmado) {
              await axios.delete(`${API_URL}/contactos/eliminar_contacto/${id}`);
              mostrarNotificacion('Contacto eliminado correctamente', 'success');
              fetchContactos(); // Refresca la lista
            }
          } catch (error) {
            console.error('Error al eliminar el contacto:', error);
            mostrarNotificacion(error.response?.data?.error || 'No se pudo eliminar el contacto. Inténtalo de nuevo.', 'error');
          }
        };

        // Crear Proforma y Factura
        const crearProforma = (id) => {
          // Guardar filtros antes de navegar
          guardarFiltros();
          // Asegurarnos de que el origen se guarda en sessionStorage
          sessionStorage.setItem('origenProforma', 'contactos');
          window.location.href = `GESTION_PROFORMAS.html?idContacto=${id}&origen=contactos`;
        };

        const crearFactura = (id) => {
          console.log(`Crear Factura para el contacto ID:&& ${id}`);
          guardarFiltros();
          // Guardar origen para volver a la lista de facturas
          sessionStorage.setItem('origenFactura', 'facturas');
          window.location.href = `GESTION_FACTURAS.html?idContacto=${id}`;
          // TODO: Implementar la creación de factura
        };

        // Función para mostrar errores
        const mostrarError = (mensaje) => {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'error-message';
          errorDiv.textContent = mensaje;
          errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #ff4444;
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          `;
          document.body.appendChild(errorDiv);
          setTimeout(() => {
            errorDiv.remove();
          }, 3000);
        };

        // Manejo de la búsqueda (con debounce)
        let debounceTimer = null;
        const handleSearch = () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            pagination.page = 1; // Reiniciar a primera página al cambiar filtros
            guardarFiltros();
            fetchContactos();
          }, 300);
        };

        const nextPage = () => {
          if (pagination.page < pagination.totalPages) {
            pagination.page += 1;
            guardarFiltros();
            fetchContactos();
          }
        };

        const prevPage = () => {
          if (pagination.page > 1) {
            pagination.page -= 1;
            guardarFiltros();
            fetchContactos();
          }
        };

        const handlePageSizeChange = () => {
          if (![10,20,50,100].includes(pagination.pageSize)) {
            pagination.pageSize = 10;
          }
          pagination.page = 1; // Volver a primera página al cambiar tamaño
          guardarFiltros();
          fetchContactos();
        };

        const changePageSize = (value) => {
          pagination.pageSize = Number(value);
          handlePageSizeChange();
        };

        // Ver contacto existente
        const verContacto = (id) => {
          // Guardar filtros antes de navegar
          guardarFiltros();
          window.location.href = `GESTION_CONTACTOS.html?id=${id}`;
        };

        // Nuevo contacto
        const nuevoContacto = () => {
          // Guardar filtros antes de navegar
          guardarFiltros();
          window.location.href = 'GESTION_CONTACTOS.html';
        };

        // Cargar datos al montar el componente
        onMounted(async () => {
          // Restaurar filtros guardados
          restaurarFiltros();
          // Cargar contactos
          await fetchContactos();
          // Poner el foco en el campo de razón social usando nextTick
          Vue.nextTick(() => {
            const razonSocialInput = document.getElementById('razonSocial');
            if (razonSocialInput) {
              razonSocialInput.focus();
            }
          });
        });

        // Función para validar el formulario
        const validateForm = () => {
          return true; // En la consulta no necesitamos validación
        };

        return {
          filters,
          contactos,
          loading,
          deleteContacto,
          crearProforma,
          crearFactura,
          handleSearch,
          verContacto,
          nuevoContacto,
          validateForm,
          pagination,
          nextPage,
          prevPage,
          handlePageSizeChange
          ,changePageSize
        };
      }
    }).mount('#app');
  </script>
  
  <!-- Contenedor para notificaciones -->
  <div id="notificaciones-contenedor"></div>
</body>
</html>