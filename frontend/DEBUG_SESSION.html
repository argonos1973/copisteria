<!DOCTYPE html>
<html>
<head>
    <title>Debug Session - Cloudflare Fix</title>
    <script src="/static/session_manager.js?v=1763897790"></script>
    <style>
        body { font-family: monospace; padding: 20px; background: #f0f0f0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .section { margin: 20px 0; padding: 15px; background: #f9f9f9; border: 1px solid #ddd; }
        h2 { color: #2c3e50; }
        pre { background: #2c3e50; color: #0f0; padding: 10px; overflow-x: auto; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        button { padding: 10px 20px; margin: 5px; background: #3498db; color: white; border: none; cursor: pointer; }
        button:hover { background: #2980b9; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Sesi√≥n - Cloudflare</h1>
        
        <div class="section">
            <h2>1. Informaci√≥n del Navegador</h2>
            <pre id="browser-info"></pre>
        </div>
        
        <div class="section">
            <h2>2. Cookies Actuales</h2>
            <pre id="cookies-info"></pre>
        </div>
        
        <div class="section" style="background: #e8f5e9; border: 2px solid #4caf50;">
            <h2>üÜï 3. Test con SessionManager (SOLUCI√ìN)</h2>
            <button onclick="testSessionManager()" style="background: #4caf50;">Login con SessionManager</button>
            <button onclick="showSessionStorage()">Ver localStorage</button>
            <button onclick="clearSessionStorage()">Limpiar localStorage</button>
            <pre id="session-manager-result"></pre>
        </div>
        
        <div class="section">
            <h2>4. Test de Login Original</h2>
            <button onclick="testLogin()">Probar Login</button>
            <pre id="login-result"></pre>
        </div>
        
        <div class="section">
            <h2>4. Test de Sesi√≥n</h2>
            <button onclick="testSession()">Verificar Sesi√≥n</button>
            <pre id="session-result"></pre>
        </div>
        
        <div class="section">
            <h2>5. Test de API con Datos</h2>
            <button onclick="testAPI()">Probar API Tickets</button>
            <pre id="api-result"></pre>
        </div>
        
        <div class="section">
            <h2>6. Headers de Request</h2>
            <pre id="headers-info"></pre>
        </div>
    </div>
    
    <script>
        // Mostrar informaci√≥n del navegador
        document.getElementById('browser-info').textContent = JSON.stringify({
            userAgent: navigator.userAgent,
            cookieEnabled: navigator.cookieEnabled,
            protocol: window.location.protocol,
            host: window.location.host,
            origin: window.location.origin
        }, null, 2);
        
        // Mostrar cookies
        function showCookies() {
            const cookies = document.cookie.split(';').map(c => c.trim());
            document.getElementById('cookies-info').textContent = JSON.stringify({
                count: cookies.length,
                cookies: cookies,
                hasSessionCookie: cookies.some(c => c.startsWith('aleph70_session'))
            }, null, 2);
        }
        showCookies();
        
        // Test de login
        async function testLogin() {
            const result = document.getElementById('login-result');
            result.textContent = 'Probando login...';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',  // IMPORTANTE
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123',
                        empresa: 'copisteria'
                    })
                });
                
                const data = await response.json();
                result.textContent = JSON.stringify({
                    status: response.status,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: data
                }, null, 2);
                
                // Actualizar cookies
                setTimeout(showCookies, 100);
                
            } catch (error) {
                result.textContent = 'ERROR: ' + error.message;
            }
        }
        
        // Test de sesi√≥n
        async function testSession() {
            const result = document.getElementById('session-result');
            result.textContent = 'Verificando sesi√≥n...';
            
            try {
                const response = await fetch('/api/auth/session', {
                    credentials: 'include'  // IMPORTANTE
                });
                
                const data = await response.json();
                result.textContent = JSON.stringify({
                    status: response.status,
                    data: data
                }, null, 2);
                
            } catch (error) {
                result.textContent = 'ERROR: ' + error.message;
            }
        }
        
        // Test de API
        async function testAPI() {
            const result = document.getElementById('api-result');
            result.textContent = 'Probando API...';
            
            try {
                const url = '/api/tickets/paginado?fecha_inicio=2025-11-01&fecha_fin=2025-11-30&page=1&page_size=2&sort=fecha&order=DESC';
                const response = await fetch(url, {
                    credentials: 'include'  // IMPORTANTE
                });
                
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch {
                    data = text;
                }
                
                result.textContent = JSON.stringify({
                    status: response.status,
                    url: url,
                    dataType: typeof data,
                    data: data
                }, null, 2);
                
            } catch (error) {
                result.textContent = 'ERROR: ' + error.message;
            }
        }
        
        // Mostrar headers
        fetch('/api/version', {
            credentials: 'include'
        }).then(response => {
            document.getElementById('headers-info').textContent = JSON.stringify({
                responseHeaders: Object.fromEntries(response.headers.entries())
            }, null, 2);
        });
        
        // Funciones para SessionManager
        async function testSessionManager() {
            const result = document.getElementById('session-manager-result');
            result.textContent = 'Probando SessionManager...';
            
            try {
                const loginResult = await window.sessionManager.login('admin', 'admin123', 'copisteria');
                
                if (loginResult.success) {
                    result.textContent = '‚úÖ LOGIN EXITOSO CON SESSIONMANAGER\n\n';
                    result.textContent += JSON.stringify(loginResult.data, null, 2);
                    result.textContent += '\n\nüì¶ Datos guardados en localStorage:\n';
                    result.textContent += localStorage.getItem('aleph70_session');
                    
                    // Probar una llamada a la API
                    setTimeout(async () => {
                        result.textContent += '\n\nüîç Probando API con sesi√≥n de localStorage...';
                        const response = await fetch('/api/tickets/paginado?fecha_inicio=2025-11-01&fecha_fin=2025-11-30&page=1&page_size=1');
                        const data = await response.json();
                        result.textContent += '\n\n‚úÖ Respuesta API:\n' + JSON.stringify(data, null, 2).substring(0, 500) + '...';
                    }, 1000);
                } else {
                    result.textContent = '‚ùå Error: ' + (loginResult.error || 'Unknown error');
                }
            } catch (error) {
                result.textContent = '‚ùå ERROR: ' + error.message;
            }
        }
        
        function showSessionStorage() {
            const result = document.getElementById('session-manager-result');
            const stored = localStorage.getItem('aleph70_session');
            if (stored) {
                result.textContent = 'üì¶ localStorage content:\n' + JSON.stringify(JSON.parse(stored), null, 2);
            } else {
                result.textContent = '‚ùå No hay sesi√≥n en localStorage';
            }
        }
        
        function clearSessionStorage() {
            localStorage.clear();
            window.sessionManager.clearSession();
            document.getElementById('session-manager-result').textContent = '‚úÖ localStorage limpiado';
            showCookies();
        }
        
        // Auto-refresh cada 5 segundos
        setInterval(showCookies, 5000);
    </script>
</body>
</html>
