<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Aleph70</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f5f5f5;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
        }
        
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 1.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .badge-success {
            background-color: #28a745;
        }
        
        .badge-danger {
            background-color: #dc3545;
        }
        
        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .form-check-input:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        
        .alert {
            border-radius: 8px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-users"></i> Gestión de Usuarios</h1>
            <a href="/api/auth/app" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Volver al Sistema
            </a>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Botón Nuevo Usuario -->
        <div class="card">
            <div class="card-body">
                <button class="btn btn-primary btn-lg" onclick="mostrarModalNuevoUsuario()">
                    <i class="fas fa-user-plus"></i> Crear Nuevo Usuario
                </button>
                <button class="btn btn-secondary btn-lg ms-3" onclick="cargarUsuarios()">
                    <i class="fas fa-sync"></i> Actualizar Lista
                </button>
            </div>
        </div>

        <!-- Lista de Usuarios -->
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-list"></i> Usuarios del Sistema</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Usuario</th>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th>Empresa</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usuariosTableBody">
                            <tr>
                                <td colspan="7" class="text-center">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando usuarios...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nuevo Usuario -->
    <div class="modal fade" id="modalNuevoUsuario" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus"></i> Crear Nuevo Usuario
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNuevoUsuario">
                        <div class="mb-3">
                            <label class="form-label">Nombre de Usuario *</label>
                            <input type="text" class="form-control" id="username" required>
                            <small class="text-muted">Este será el usuario para iniciar sesión</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Nombre Completo *</label>
                            <input type="text" class="form-control" id="nombre_completo" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Contraseña *</label>
                            <input type="password" class="form-control" id="password" required minlength="6">
                            <small class="text-muted">Mínimo 6 caracteres</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono">
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="asignarEmpresa">
                                <label class="form-check-label" for="asignarEmpresa">
                                    Asignar a mi empresa actual
                                </label>
                            </div>
                            <small class="text-muted">
                                Si no marcas esta opción, el usuario se creará sin empresa asignada
                            </small>
                        </div>
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Los usuarios sin empresa solo tendrán acceso al menú de Gestión
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="crearUsuario()">
                        <i class="fas fa-save"></i> Crear Usuario
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let usuarios = [];
        let modalNuevoUsuario = null;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            modalNuevoUsuario = new bootstrap.Modal(document.getElementById('modalNuevoUsuario'));
            cargarUsuarios();
        });

        // Cargar lista de usuarios
        async function cargarUsuarios() {
            try {
                const response = await fetch('/api/admin/usuarios');
                if (!response.ok) throw new Error('Error al cargar usuarios');
                
                usuarios = await response.json();
                mostrarUsuarios();
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar usuarios', 'danger');
            }
        }

        // Mostrar usuarios en la tabla
        function mostrarUsuarios() {
            const tbody = document.getElementById('usuariosTableBody');
            
            if (usuarios.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            No hay usuarios registrados
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = usuarios.map(usuario => `
                <tr>
                    <td>${usuario.id}</td>
                    <td><strong>${usuario.username}</strong></td>
                    <td>${usuario.nombre_completo || '-'}</td>
                    <td>${usuario.email || '-'}</td>
                    <td>
                        ${usuario.empresa_nombre ? 
                            `<span class="badge bg-info">${usuario.empresa_nombre}</span>` : 
                            `<span class="badge bg-warning">Sin empresa</span>`
                        }
                    </td>
                    <td>
                        ${usuario.activo ? 
                            '<span class="badge bg-success">Activo</span>' : 
                            '<span class="badge bg-danger">Inactivo</span>'
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" 
                                onclick="editarUsuario(${usuario.id})"
                                title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${!usuario.empresa_nombre ? `
                            <button class="btn btn-sm btn-outline-info" 
                                    onclick="asignarEmpresa(${usuario.id})"
                                    title="Asignar Empresa">
                                <i class="fas fa-building"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="toggleUsuario(${usuario.id}, ${usuario.activo})"
                                title="${usuario.activo ? 'Desactivar' : 'Activar'}">
                            <i class="fas fa-${usuario.activo ? 'ban' : 'check'}"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Mostrar modal nuevo usuario
        function mostrarModalNuevoUsuario() {
            document.getElementById('formNuevoUsuario').reset();
            modalNuevoUsuario.show();
        }

        // Crear nuevo usuario
        async function crearUsuario() {
            const form = document.getElementById('formNuevoUsuario');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const datos = {
                username: document.getElementById('username').value,
                nombre_completo: document.getElementById('nombre_completo').value,
                password: document.getElementById('password').value,
                email: document.getElementById('email').value || null,
                telefono: document.getElementById('telefono').value || null,
                asignar_empresa: document.getElementById('asignarEmpresa').checked
            };

            try {
                const response = await fetch('/api/admin/usuarios/crear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(datos)
                });

                const result = await response.json();
                
                if (response.ok) {
                    mostrarAlerta('Usuario creado exitosamente', 'success');
                    modalNuevoUsuario.hide();
                    cargarUsuarios();
                } else {
                    mostrarAlerta(result.error || 'Error al crear usuario', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al crear usuario', 'danger');
            }
        }

        // Activar/Desactivar usuario
        async function toggleUsuario(id, estadoActual) {
            if (!confirm(`¿Deseas ${estadoActual ? 'desactivar' : 'activar'} este usuario?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/usuarios/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ activo: !estadoActual })
                });

                if (response.ok) {
                    mostrarAlerta('Usuario actualizado', 'success');
                    cargarUsuarios();
                } else {
                    mostrarAlerta('Error al actualizar usuario', 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al actualizar usuario', 'danger');
            }
        }

        // Mostrar alerta
        function mostrarAlerta(mensaje, tipo) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo} alert-dismissible fade show`;
            alert.innerHTML = `
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.innerHTML = '';
            container.appendChild(alert);
            
            // Auto-cerrar después de 5 segundos
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Placeholder para editar usuario
        function editarUsuario(id) {
            alert('Función de edición en desarrollo');
        }

        // Placeholder para asignar empresa
        function asignarEmpresa(id) {
            alert('Función de asignación de empresa en desarrollo');
        }
    </script>
</body>
</html>
